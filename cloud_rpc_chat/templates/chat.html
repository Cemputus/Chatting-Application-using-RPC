<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>RPC Chat – Web UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        background: #020617;
        border-radius: 12px;
        padding: 16px;
        width: min(900px, 100vw - 24px);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
        border: 1px solid #1f2937;
        display: flex;
        flex-direction: row;
        gap: 12px;
      }

      .sidebar {
        width: 180px;
        border-right: 1px solid #1f2937;
        padding-right: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sidebar-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9ca3af;
      }

      .room-button {
        width: 100%;
        text-align: left;
        padding: 6px 10px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid transparent;
        color: #e5e7eb;
        font-size: 0.85rem;
      }

      .room-button.active {
        background: #0f172a;
        border-color: #38bdf8;
      }

      .room-button.secondary {
        border-color: #1f2937;
      }

      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .header h1 {
        font-size: 1.1rem;
        margin: 0;
      }

      .username-input {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      input[type="text"] {
        background: #020617;
        border: 1px solid #374151;
        border-radius: 999px;
        padding: 6px 10px;
        color: #e5e7eb;
        outline: none;
        flex: 1;
      }

      input[type="text"]:focus {
        border-color: #38bdf8;
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 6px 14px;
        font-size: 0.85rem;
        cursor: pointer;
        background: #0ea5e9;
        color: #020617;
        font-weight: 600;
      }

      button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .messages {
        background: #020617;
        border-radius: 10px;
        border: 1px solid #1f2937;
        padding: 10px;
        height: 360px;
        overflow-y: auto;
        font-size: 0.9rem;
      }

      .message {
        margin-bottom: 6px;
      }

      .message .meta {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .message .text {
        margin-left: 4px;
      }

      .message.you .meta {
        color: #4ade80;
      }

      .footer {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .status {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 2px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="sidebar-title">Chats</div>
        <button
          id="room-public"
          class="room-button active"
          type="button"
        >
          Public chat
        </button>
        <button
          id="room-founders"
          class="room-button secondary"
          type="button"
          disabled
        >
          Founders chat
        </button>
      </div>

      <div class="main">
        <div class="header">
          <h1>RPC Chat – Web Client</h1>
          <div class="username-input">
            <input
              id="username"
              type="text"
              placeholder="Enter username (e.g. Edube, Nsubuga)"
            />
            <button id="lock-username">Lock</button>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="footer">
          <input
            id="message-input"
            type="text"
            placeholder="Type a message and press Enter…"
          />
          <button id="send-button">Send</button>
        </div>
        <div id="status" class="status">Disconnected</div>
      </div>
    </div>

    <script>
      const LEGACY_USERS = {{ legacy_users|tojson }};
      const messagesEl = document.getElementById("messages");
      const messageInputEl = document.getElementById("message-input");
      const sendButtonEl = document.getElementById("send-button");
      const usernameEl = document.getElementById("username");
      const lockUsernameEl = document.getElementById("lock-username");
      const statusEl = document.getElementById("status");
      const roomPublicEl = document.getElementById("room-public");
      const roomFoundersEl = document.getElementById("room-founders");

      let username = "";
      let lastId = 0;
      let currentRoom = "public";
      let isLegacyUser = false;

      function appendMessage({ id, username: author, text, timestamp }) {
        const ts = new Date(timestamp * 1000);
        const timeString = ts.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        const wrapper = document.createElement("div");
        wrapper.className = "message" + (author === username ? " you" : "");

        const meta = document.createElement("span");
        meta.className = "meta";
        meta.textContent = `[${timeString}] ${author}${
          author === username ? " (you)" : ""
        }`;

        const textEl = document.createElement("span");
        textEl.className = "text";
        textEl.textContent = `: ${text}`;

        wrapper.appendChild(meta);
        wrapper.appendChild(textEl);

        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function setActiveRoom(room) {
        currentRoom = room;
        lastId = 0;
        messagesEl.innerHTML = "";

        roomPublicEl.classList.toggle("active", room === "public");
        roomFoundersEl.classList.toggle("active", room === "founders");
        statusEl.textContent =
          room === "founders"
            ? "Founders chat (legacy users only)"
            : "Public chat";

        fetchMessages();
      }

      async function fetchMessages() {
        try {
          const params = new URLSearchParams({
            last_id: String(lastId),
            room: currentRoom,
          });
          const resp = await fetch(`/api/messages?${params.toString()}`);
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }
          const data = await resp.json();
          if (Array.isArray(data)) {
            for (const msg of data) {
              appendMessage(msg);
              if (msg.id > lastId) {
                lastId = msg.id;
              }
            }
          }
          statusEl.textContent = "Connected";
        } catch (err) {
          statusEl.textContent = `Receive error: ${err}`;
        }
      }

      async function sendMessage() {
        const text = messageInputEl.value.trim();
        if (!text || !username) {
          return;
        }

        try {
          const resp = await fetch("/api/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, text, room: currentRoom }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || `HTTP ${resp.status}`);
          }

          // Optimistic local append; also bump lastId so we do NOT
          // re-render the same message when the server echoes it back.
          const tsNow = Date.now() / 1000;
          const newId =
            typeof data.id === "number" && Number.isFinite(data.id)
              ? data.id
              : lastId + 1;
          appendMessage({
            id: newId,
            username,
            text,
            timestamp: tsNow,
          });
          if (newId > lastId) {
            lastId = newId;
          }

          messageInputEl.value = "";
          statusEl.textContent = "Connected";
        } catch (err) {
          statusEl.textContent = `Send error: ${err}`;
        }
      }

      sendButtonEl.addEventListener("click", sendMessage);
      messageInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      lockUsernameEl.addEventListener("click", () => {
        const value = usernameEl.value.trim();
        if (!value) {
          return;
        }
        username = value;
        try {
          window.localStorage.setItem("rpcChatUsername", username);
        } catch (e) {
          // If localStorage is unavailable, continue without persistence.
        }
        isLegacyUser = LEGACY_USERS.includes(username);
        roomFoundersEl.disabled = !isLegacyUser;
        usernameEl.disabled = true;
        lockUsernameEl.disabled = true;
        messageInputEl.focus();
      });

      // Rehydrate username from localStorage so the lock survives refreshes.
      try {
        const stored = window.localStorage.getItem("rpcChatUsername");
        if (stored) {
          username = stored;
          usernameEl.value = stored;
          isLegacyUser = LEGACY_USERS.includes(username);
          roomFoundersEl.disabled = !isLegacyUser;
          usernameEl.disabled = true;
          lockUsernameEl.disabled = true;
        }
      } catch (e) {
        // Ignore localStorage errors.
      }

      roomPublicEl.addEventListener("click", () => {
        setActiveRoom("public");
      });

      roomFoundersEl.addEventListener("click", () => {
        if (!isLegacyUser) {
          statusEl.textContent =
            "Only legacy users from the original chat can access the Founders room.";
          return;
        }
        setActiveRoom("founders");
      });

      // Start polling loop.
      setInterval(fetchMessages, 1000);
      fetchMessages();
    </script>
  </body>
</html>

